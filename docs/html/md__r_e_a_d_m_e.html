<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BQ28Z610 Driver: Custom Arduino Driver for Battery Gas Gauging Device BQ28Z610</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BQ28Z610 Driver
   </div>
   <div id="projectbrief">BQ28Z610 Battery fuel gauge device driver for Arduino</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Custom Arduino Driver for Battery Gas Gauging Device BQ28Z610 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><img src="https://github.com/user-attachments/assets/92a0b1af-471d-4496-8bc8-e6f9120a4c4d" alt="Arduino BQ28Z610 Driver" width="600" class="inline"/></p>
<p>This is a driver for Arduino that provides functions to interface with the BQ28Z610 battery gas gauge device over I2C protocol.</p>
<p>With this driver, you can operate the BQ28Z610 device via the serial port from your computer using Arduino.</p>
<p>Functions were implemented based on the documentation:</p>
<ul>
<li>Technical Reference Manual (c) Texas Instruments, Literature Number: SLUUA65E, <a href="https://www.ti.com/lit/ug/sluua65e/sluua65e.pdf">https://www.ti.com/lit/ug/sluua65e/sluua65e.pdf</a></li>
</ul>
<p>Not all functions described in the Technical Reference Manual were implemented, but most of them.</p>
<p>The driver also includes some additional service functions for more usability.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Project Files</h1>
<ul>
<li><a href="#-bq28z610-arduino-driverino">bq28z610-arduino-driver.ino</a></li>
<li><a href="#-doxyfile">doxyfile</a></li>
<li>[std_data_commands](std_data_commands)</li>
<li><a href="#-alt_manufacturer_access">alt_manufacturer_access</a></li>
<li><a href="#-data_flash_access">data_flash_access</a></li>
<li><a href="#-service">service</a></li>
<li><a href="#-utils">utils</a></li>
<li><a href="#-flagsh">flags.h</a></li>
<li><a href="#-globalsh">globals.h</a></li>
<li>/extras/data_flash/:<ul>
<li><a href="#-data_flashpy">data_flash.py</a></li>
<li><a href="#-data_descriptionscsv">data/data_descriptions.csv</a></li>
<li><a href="#-dump-files">dump files</a></li>
</ul>
</li>
</ul>
<p>Next, I will provide a brief description of the file contents.</p>
<p>For a complete description of all functions, follow the link: <a href="https://asilichenko.github.io/bq28z610-arduino-driver/files.html">https://asilichenko.github.io/bq28z610-arduino-driver/files.html</a></p>
<h2><a class="anchor" id="autotoc_md2"></a>
ðŸ“„ bq28z610-arduino-driver.ino</h2>
<p>The main Arduino sketch file.</p>
<ol type="1">
<li>Wait 5 seconds to prevent launching the code when resetting while uploading new sketch to Arduino.</li>
<li>Init Serial port.</li>
<li>Init Wire (I2C) interface.</li>
</ol>
<p>There is some sample code in the setup function:</p>
<ul>
<li>Calling "read and print" functions from different sections.</li>
<li>Example of using the SILENCE constant and printing the results of the called functions.</li>
</ul>
<p>An example of the output result in the serial port from executing this code can be viewed at the link: <a href="extras/example-output.txt">example-output.txt</a></p>
<p>ðŸ”— <a href="bq28z610-arduino-driver.ino">bq28z610-arduino-driver.ino</a></p>
<h2><a class="anchor" id="autotoc_md3"></a>
ðŸ“„ doxyfile</h2>
<p>This file describes the settings to be used by the documentation system doxygen (www.doxygen.org) for a project.</p>
<p>Output directory for the generated documentation is "[/docs/](docs)".</p>
<p>ðŸ”— [doxyfile](doxyfile)</p>
<h2><a class="anchor" id="autotoc_md4"></a>
ðŸ“„ std_data_commands</h2>
<p>Functions described in the section "_12.1 Standard Data Commands_" of the Technical Reference Manual.</p>
<p>ðŸ”— <a href="std_data_commands.h">std_data_commands.h</a> | <a href="std_data_commands.cpp">std_data_commands.cpp</a></p>
<h2><a class="anchor" id="autotoc_md5"></a>
ðŸ“„ alt_manufacturer_access</h2>
<p>Functions described in the section "_12.2 0x3E, 0x3F AltManufacturerAccess()_" of the Technical Reference Manual.</p>
<p>ðŸ”— <a href="alt_manufacturer_access.h">alt_manufacturer_access.h</a> | <a href="alt_manufacturer_access.cpp">alt_manufacturer_access.cpp</a></p>
<h2><a class="anchor" id="autotoc_md6"></a>
ðŸ“„ data_flash_access</h2>
<p>Functions to read data from the Data Flash and write to the Data Flash, according to:</p>
<ul>
<li>12.2.45 Data Flash Access() 0x4000â€“0x5FFF</li>
<li>13 Data Flash Values</li>
<li>14 Data Flash Summary</li>
</ul>
<p>To access the data flash, your device needs to be in an UNSEALED state (UNSEALED is enough; Full Access state is not necessary).</p>
<p>The default Unseal Key is defined in the class <a class="el" href="class_device_security.html" title="Chapter 9 Device Security.">DeviceSecurity</a> in the file <a href="globals.h">globals.h</a>.</p>
<p>Contains such constants and functions as:</p>
<ul>
<li>Data Flash addresses constants</li>
<li>Read and write single byte, word and array (maximum 32 bytes)</li>
<li>Read data in the String format</li>
<li>Read and write values for named Data Flash data</li>
<li>Print Ra Table</li>
<li>Reset Ra Table flags</li>
<li>Print Data Flash dump</li>
</ul>
<p>The Technical Reference Manual only contains descriptions up to address 0x4727, but there is some data in the rest of the Data Flash.</p>
<p>Some addresses within the standard region are prohibited from writing, although I am not sure about the exact ranges of these addresses. For example, around the address 0x5A5A, there is no data (bytes are 0xFF) and they cannot be overwritten.</p>
<p>ðŸ”— <a href="data_flash_access.h">data_flash_access.h</a> | <a href="data_flash_access.cpp">data_flash_access.cpp</a></p>
<h2><a class="anchor" id="autotoc_md7"></a>
ðŸ“„ service</h2>
<p>Additional service functions for the device, like:</p>
<ul>
<li>Unsealing the device</li>
<li>Check if the device is in the Permanent Fail state</li>
<li>Get current security mode</li>
<li>Put Charge or Discharge FET into the specific state</li>
<li>Get specific data from raw-data commands like DAStatus and ITStatus</li>
<li>Print current state of the flags important for some protections (Undervoltage, Overtemperature, Short circuit in charge and discharge, etc.)</li>
<li>Print flags that correspond to the FETs status, to determine whether they are enabled and why</li>
<li>Enable or Disable turning charging FET off at 60% SOC (see: <a href="https://www.linkedin.com/pulse/how-stop-battery-charging-specific-percentage-oleksii-sylichenko-vpmkf">https://www.linkedin.com/pulse/how-stop-battery-charging-specific-percentage-oleksii-sylichenko-vpmkf</a>)</li>
<li>Init the device before the Learning Cycle (see: <a href="https://www.linkedin.com/pulse/gas-gauging-device-bq28z610-learning-cycle-practical-guide-oleksii-ngk8f">https://www.linkedin.com/pulse/gas-gauging-device-bq28z610-learning-cycle-practical-guide-oleksii-ngk8f</a>)</li>
<li>Print information important to be checked periodically during the learning cycle (see: <a href="https://www.linkedin.com/pulse/gas-gauging-device-bq28z610-learning-cycle-practical-guide-oleksii-ngk8f">https://www.linkedin.com/pulse/gas-gauging-device-bq28z610-learning-cycle-practical-guide-oleksii-ngk8f</a>)</li>
<li>Get and set some thresholds</li>
</ul>
<p>ðŸ”— <a href="service.h">service.h</a> | <a href="service.cpp">service.cpp</a></p>
<h2><a class="anchor" id="autotoc_md8"></a>
ðŸ“„ utils</h2>
<p>Util functions for:</p>
<ul>
<li>Printing into serial port</li>
<li>Composing full values from bytes</li>
<li>Sending and receiving data via I2C protocol</li>
<li>Implementation of the high-level Block Protocol of the device</li>
</ul>
<p>ðŸ”— <a href="utils.h">utils.h</a> | <a href="utils.cpp">utils.cpp</a></p>
<h2><a class="anchor" id="autotoc_md9"></a>
ðŸ“„ flags.h</h2>
<p>Definition of the flag constants with the descriptions.</p>
<p>ðŸ”— <a href="flags.h">flags.h</a></p>
<h2><a class="anchor" id="autotoc_md10"></a>
ðŸ“„ globals.h</h2>
<p>Definition of the global constants except flags, like:</p>
<ul>
<li>I2C address of the Device</li>
<li>Security modes</li>
<li>Unseal keys</li>
<li>Block protocol parameters</li>
<li>Codes of the "_12.1 Standard Data Commands_"</li>
<li>Codes of the "_12.2 0x3E, 0x3F Alt Manufacturer Access Commands_"</li>
<li>Constants for some raw data commands like DAStatus and ITStatus</li>
<li>Strings that represent units of measurement</li>
</ul>
<p>ðŸ”— <a href="globals.h">globals.h</a></p>
<h2><a class="anchor" id="autotoc_md11"></a>
ðŸ“„ data_flash.py</h2>
<p>Python script for processing the Data Flash dump, printed by the function from the data_flash_access:</p>
<ul>
<li>Load from the text file</li>
<li>Print data detailed - values with addresses and captions from the "_14.1 Data Flash Table_" of the Technical Manual</li>
<li>Compare two dumps and print the differences</li>
</ul>
<p>ðŸ”— <a href="extras/data_flash/data_flash.py">data_flash.py</a></p>
<h2><a class="anchor" id="autotoc_md12"></a>
ðŸ“„ data_descriptions.csv</h2>
<p>Csv-file which contains list of Data Flash entities taken from the table "_14.1 Data Flash Table_":</p>
<ul>
<li>Physical address</li>
<li>Data format (I4, U2, H1, F4, S5, etc.) that represents column "Type"</li>
<li>Description which is a join of the columns: "Class", "Subclass" and "Name" separated by "/" symbol</li>
</ul>
<p>ðŸ”— <a href="extras/data_flash/data/data_descriptions.csv">data_descriptions.csv</a></p>
<h2><a class="anchor" id="autotoc_md13"></a>
ðŸ“‚ dump files</h2>
<p>I included several Data Flash dump files of my BQ28Z610 device:</p>
<ul>
<li><a href="extras/data_flash/data/dump/dump-original.txt">dump-original.txt</a> - a dump before any changes over Data Flash were made</li>
<li><a href="extras/data_flash/data/dump/dump-20240710.txt">dump-20240710.txt</a> - a dump after some changes have been written to the Data Flash</li>
<li><a href="extras/data_flash/data/dump/dump-20240710-after-lifetime-reset.txt">dump-20240710-after-lifetime-reset.txt</a> - a dump to check how the function "_12.2.19 AltManufacturerAccess() 0x0028 Lifetime Data Reset_" works</li>
<li><a href="extras/data_flash/data/output/dump-original-detailed.txt">dump-original-detailed.txt</a> - the result of detailing a raw dump</li>
</ul>
<h1><a class="anchor" id="autotoc_md14"></a>
Arduino Nano Connection</h1>
<ul>
<li>GND -&gt; black</li>
<li>A4 = SDA -&gt; white</li>
<li>A5 = SCL -&gt; yellow</li>
</ul>
<h1><a class="anchor" id="autotoc_md15"></a>
Author</h1>
<p><a href="https://github.com/asilichenko">@asilichenko</a></p>
<h1><a class="anchor" id="autotoc_md16"></a>
License</h1>
<p>[MIT license](LICENSE)</p>
<h1><a class="anchor" id="autotoc_md17"></a>
References</h1>
<ul>
<li>Texas Instruments BQ28Z610 Technical Reference Manual: <a href="https://www.ti.com/lit/ug/sluua65e/sluua65e.pdf">https://www.ti.com/lit/ug/sluua65e/sluua65e.pdf</a></li>
<li>BQ28Z610 product: <a href="https://www.ti.com/product/BQ28Z610">https://www.ti.com/product/BQ28Z610</a></li>
<li>Texas Instruments Power Management Forum: <a href="https://e2e.ti.com/support/power-management-group/power-management/f/power-management-forum">https://e2e.ti.com/support/power-management-group/power-management/f/power-management-forum</a></li>
<li>How to Stop Battery Charging at a Specific Percentage: <a href="https://www.linkedin.com/pulse/how-stop-battery-charging-specific-percentage-oleksii-sylichenko-vpmkf">https://www.linkedin.com/pulse/how-stop-battery-charging-specific-percentage-oleksii-sylichenko-vpmkf</a></li>
<li>Gas Gauging Device BQ28Z610 Learning Cycle: Practical Guide: <a href="https://www.linkedin.com/pulse/gas-gauging-device-bq28z610-learning-cycle-practical-guide-oleksii-ngk8f">https://www.linkedin.com/pulse/gas-gauging-device-bq28z610-learning-cycle-practical-guide-oleksii-ngk8f</a></li>
<li>Doxygen, documentation generator tool: <a href="https://www.doxygen.nl">https://www.doxygen.nl</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md18"></a>
Sources</h1>
<ul>
<li><a href="bq28z610-arduino-driver.ino">bq28z610-arduino-driver.ino</a></li>
<li>[doxyfile](doxyfile)</li>
<li><a href="std_data_commands.h">std_data_commands.h</a> | <a href="std_data_commands.cpp">std_data_commands.cpp</a></li>
<li><a href="alt_manufacturer_access.h">alt_manufacturer_access.h</a> | <a href="alt_manufacturer_access.cpp">alt_manufacturer_access.cpp</a></li>
<li><a href="data_flash_access.h">data_flash_access.h</a> | <a href="data_flash_access.cpp">data_flash_access.cpp</a></li>
<li><a href="service.h">service.h</a> | <a href="service.cpp">service.cpp</a></li>
<li><a href="utils.h">utils.h</a> | <a href="utils.cpp">utils.cpp</a></li>
<li><a href="flags.h">flags.h</a></li>
<li><a href="globals.h">globals.h</a></li>
<li><a href="extras/data_flash/data_flash.py">data_flash.py</a></li>
<li>Documentation generated by Doxygen: <a href="https://asilichenko.github.io/bq28z610-arduino-driver/">https://asilichenko.github.io/bq28z610-arduino-driver/</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.0
</small></address>
</body>
</html>
